---
title: "Results"
author: "Daniel Bartušek"
date: "17/07/2021"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
library(plotly)
library(ggplot2)
library(data.table)
dt <- readRDS("./data-interim/sections.rds")
sum <- readRDS("./data-interim/summary.rds")
knitr::opts_chunk$set(echo = TRUE)
```


```{r priprava, echo=FALSE}
abs_metrics<-dt %>%
  filter(rok == 2020, typ_rozpoctu == "SCHV") %>%
  filter(!is.na(as.numeric(kap_num))) %>%
  filter(!name %in% c("ROPO","SS","OSS")) %>%
  group_by(kap_name) %>%
  summarise(pocet_zamestnancu = sum(pocet_zamestnancu),
            prostredky_na_platy = sum(prostredky_na_platy),
            prumerny_plat = sum(prumerny_plat))

bar_dt <- dt %>%
  filter(rok == 2020, typ_rozpoctu == "SCHV") %>%
  filter(!is.na(as.numeric(kap_num))) %>%
  filter(!name %in% c("ROPO","SS","OSS"))

sum_all<- sum %>%
  select(name,rok,typ_rozpoctu,prostredky_na_platy_a_oppp,pocet_zamestnancu) %>%
  reshape(timevar = "typ_rozpoctu",
          idvar = c("name","rok"), direction = "wide") %>%
  rename("schvaleny" = prostredky_na_platy_a_oppp.SCHV,
         "upraveny" = prostredky_na_platy_a_oppp.UPRAV,
         "skutecnost" = prostredky_na_platy_a_oppp.SKUT,
         "zam_schvaleny" = pocet_zamestnancu.SCHV,
         "zam_upraveny" = pocet_zamestnancu.UPRAV ,
         "zam_skutecnost" = pocet_zamestnancu.SKUT,
         "type" = name,
         "year" = rok) %>%
  mutate(rozdil_k_rozp = skutecnost - schvaleny,
         rozdil_ke_skut = schvaleny-skutecnost) %>%
  group_by(type)%>%
  mutate(plat_growth =  (skutecnost - dplyr::lag(skutecnost))/lag(skutecnost)*100,
         zam_growth =  (zam_skutecnost -  dplyr::lag(zam_skutecnost))/lag(zam_skutecnost)*100)

lty <- c(schvaleny = "dash", skutecnost = "solid")

```

## Výsledky prvotní analýzy

Všechny grafy byly vytvořeny pomocí plotly. Pro detailnější analýzu se může hodit udělat drag+drop výseč přímo v grafu (Zoom button), nebo odškrtnout některé z kategorií v legendě napravo. Double-clickem na kategorii v legendě je možné skrýt všechny kategorie až na tu vybranou kategorii. Pro reset je tam "Reset axes" button.

### Počty zaměstnanců per kapitola
MŠMT očividně zkreslená kvůli příspěvkovým organizacím.

```{r counts, echo=FALSE, out.width="100%"}
plot_ly(bar_dt,x=~kap_name,y=~pocet_zamestnancu,color=~name,
        text = ~ifelse(pocet_zamestnancu>0,paste(" Zdroj:", name, "<br>","Kapitola:", full_kap_name, "<br>", "Zaměstnanců:", format(pocet_zamestnancu, big.mark = ' ')),""),
        hoverinfo = "text")  %>%
  add_bars() %>%
  layout(hovermode = 'x unified',
         title="Vizualizace zaměstnanců",
         xaxis = list(title="Kapitoly",categoryorder = "array", categoryarray =arrange(abs_metrics,pocet_zamestnancu)$kap_name),
         yaxis = list(title = "Počet zaměstnanců"), barmode="stack") %>%
    config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d","pan2d","lasso2d","select2d","autoScale2d"),displaylogo = FALSE)
```

### Kumulativní platy státních zaměstnanců per kapitola
Znovu značně zkreslené MŠMT. Pomocí toho "zoom" toolu je to přehlednější.
```{r costs, echo=FALSE, out.width="100%"}
plot_ly(bar_dt,x=~kap_name,y=~prostredky_na_platy,color=~name,
           text = ~ifelse(prostredky_na_platy>0,paste(" Zdroj:", name, "<br>","Kapitola:", full_kap_name, "<br>", "Platy kumulativně:", format(prostredky_na_platy, big.mark = ' ')),""),
           hoverinfo = "text")  %>%
  add_bars() %>%
  layout(hovermode = 'x unified',
         title="Vizualizace platů",
         xaxis = list(title="Kapitoly",categoryorder = "array", categoryarray =arrange(abs_metrics,prostredky_na_platy)$kap_name),
         yaxis = list(title = "Platy"),
         barmode="stack")%>%
    config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d","pan2d","lasso2d","select2d","autoScale2d"),displaylogo = FALSE)
```


### Průměrné platy státních zaměstnanců per kapitola
Tady by bylo lepší mít platy seřazené bez ohledu na skupinu (OSS/SOBCPO/PO/UO), ale nevešlo by se tam vše. Tady je podle mě praktické využití to vypínání jednotlivých skupin v legendě.
```{r mean_costs, echo=FALSE, out.width="100%"}
plot_ly(bar_dt,x=~kap_name,y=~prumerny_plat,color=~name,
           text = ~ifelse(prumerny_plat>0,paste(" Zdroj:", name, "<br>","Kapitola:", full_kap_name, "<br>", "Prumerny plat:", format(prumerny_plat, big.mark = ' ')),""),
           hoverinfo = "text")  %>%
  add_bars() %>%
  layout(hovermode = 'x unified',
         title="Vizualizace prumernych platů",
         xaxis = list(title="Kapitoly",categoryorder = "array", categoryarray =arrange(abs_metrics,prumerny_plat)$kap_name),
         yaxis = list(title = "Prumerne platy"),
         barmode="stack") %>%
    config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d","pan2d","lasso2d","select2d","autoScale2d"),displaylogo = FALSE)
```



### Srovnání plnění rozpočtu per skupina
Plně a výrazně je skutečný rozpočet, průhledně a čárkovaně je schválený rozpočet. Většinou je skutečný logicky nad schváleným.
```{r schvaleny_X_skutecny, echo=FALSE, out.width="100%"}
sum_all %>% filter(!type %in% c("ROPO","SS","OSS","SS_bez_SOBCPO")) %>% group_by(type) %>%
  plot_ly(x=~year,y=~skutecnost,type = "scatter",color=~type, mode="lines+markers", linetypes = lty,legendgroup = ~type, name = ~paste(type,"SKUT"),
          text = ~paste(" Rok: ", year, "<br>","Zdroj:", type,
                        "<br>", " Rozpocet:", format(skutecnost, big.mark = ' '),
                        "<br>", " Rozdil ke schvalenemu:", format(rozdil_k_rozp, big.mark = ' ')),
          hoverinfo = "text") %>%
  layout(title="Porovnani schvalenych a skutecnych platu",
         xaxis = list(title="Rok"),
         yaxis = list(title = "Rozpocet")) %>%
  add_trace(y = ~schvaleny,mode = 'lines+markers', linetype = I("dot"),legendgroup = ~type, name =~paste(type,"SCHV"),
            alpha = 0.4,showlegend = T,
            text = ~paste(" Rok:", year, "<br>","Zdroj:",
                          type,"<br>", "Rozpocet:", format(schvaleny, big.mark = ' '),
                          "<br>", "Rozdil ke skutecnosti:",
                          format(rozdil_ke_skut, big.mark = ' ')),hoverinfo = "text")%>%
    config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d","pan2d","lasso2d","select2d","autoScale2d"),displaylogo = FALSE)
```

### Srovnání růstu platů s růstem zaměstnanců

Tady jsem chtěl vypozorovat jestli růst platů v nějaké skupině ovlivní úměrně i růst zaměstnanců ten samý/příští rok. Asi to není moc informativní a bylo by lepší to mít per kapitola.

```{r rust_platy_X_zam, echo=FALSE, out.width="100%"}
sum_all %>% filter(!type %in% c("ROPO","SS","OSS","SS_bez_SOBCPO")) %>% group_by(type) %>%
  plot_ly(x=~year,y=~plat_growth,type = "scatter",color=~type, mode="lines+markers",legendgroup = ~type, name = ~paste(type,"PLAT"),
          text = ~paste(" Rok: ", year, "<br>","Zdroj:", type,
                        "<br>", " Rozpocet:", format(plat_growth, big.mark = ' '),
                        "<br>", " Rozdil ke schvalenemu:", format(plat_growth, big.mark = ' ')),
          hoverinfo = "text") %>%
    layout(title="Porovnani rustu platu a zamestnancu",
         xaxis = list(title="Rok"),
         yaxis = list(title = "Zmena v procentech")) %>%
  add_trace(y = ~zam_growth,mode = 'lines+markers', linetype = I("dot"),legendgroup = ~type, name =~paste(type,"ZAM"),
            alpha = 0.4,showlegend = T,
            text = ~paste(" Rok:", year, "<br>","Zdroj:",
                          type,"<br>", "Rozpocet:", format(zam_growth, big.mark = ' '),
                          "<br>", "Rozdil ke skutecnosti:",
                          format(zam_growth, big.mark = ' ')),hoverinfo = "text")%>%
    config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d","pan2d","lasso2d","select2d","autoScale2d"),displaylogo = FALSE)
```



